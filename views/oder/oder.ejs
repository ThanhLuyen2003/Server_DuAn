<%- include('../inc/header.ejs') %>

<div class="container">
    <h1 style="font-weight: bold; text-align: center; margin-top: 20px;">Danh sách đơn hàng</h1>
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <form class="d-flex" role="search"> 
          <div class="d-flex justify-content-around align-items-center mb-2">

            <div class="dropdown">
              <button style="margin-right: 30px;" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                Lọc danh mục
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item category-filter" href="#" data-category="Kem đánh răng">Kem danh rang</a></li>
                <li><a class="dropdown-item category-filter" href="#" data-category="Chăm sóc da">Cham soc da</a></li>
                <li><a class="dropdown-item category-filter" href="#" data-category="Chăm sóc cơ thể">Cham soc co the</a></li>
                <li><a class="dropdown-item category-filter" href="#" data-category="Combo">Combo</a></li>
                <li><a class="dropdown-item category-filter" href="#" data-category="Nước hoa">Nuoc hoa</a></li>
                <li><a class="dropdown-item category-filter" href="#" data-category="Sáp">Sap</a></li>
              </ul>
            </div>

            <div class="dropdown">
              <button style="margin-right: 20px;" class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                aria-expanded="false">
                Sắp xếp theo
              </button>
              
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="">Tên</a></li>
                <li><a class="dropdown-item" href="">Giá</a></li>
              </ul>
            </div>
            
          </div>

          <!-- thanh tìm kiếm -->
          <form class="form-inline my-2 my-lg-0" action="/search" method="GET">
            <button style="height: 38px;" class="btn btn-warning my-2 my-sm-0" type="submit">Tìm</button>
            <input style="height: 38px; width: 700px;" class="form-control mr-sm-2" type="text" name="billSearch" id="searchInput" placeholder="Tìm kiếm..." aria-label="Search">
          </form>

        </form>
        
      </div>
      
    </nav>
  </div>

  <div class="container">
    <table id="productTable" class="table table-bordered table-striped">
      <tr class="text-sm-center">
        <th style="width: 30px;"> Số điện thoại</th>
        <th>Địa chỉ</th>
        <th>Lời nhắn</th>
        <th>Tên khách hàng</th>
        <th>Giá</th>
        <th>Mô tả đơn hàng</th>
        <th>Thời gian đặt</th>
        <th>Trạng thái</th>
        <th></th>
      </tr>

      <% listOders.forEach( ( row )=>{ %>
        <tr>
          <td>
            <%= row.phoneU %>
          </td>
          <td>
            <%= row.addressU %>
          </td>
          <td>
            <%= row.message %>
          </td>
          <td>
            <%= row.nameU %>
          </td>
          <td>
            <%= row.price %>
          </td>

        
          <td>
            <% row.products.forEach((product) => { %>
              <p>Tên SP: <%= product.name %></p>
              <p>Số lượng mua: <%= product.quantity %></p>           
            <% }) %>
          </td>


          <td>
            <%= row.time %>
          </td>
          
          <td>
            <% if (row.status==='Có đơn') { %>
              <p style="color: #ffc107; font-weight: bold;">
                <%= row.status %>
              </p>
              <% } else if (row.status==='Đang giao hàng' ) { %>
                <p style="color: #0000ff; font-weight: bold;">
                  <%= row.status %>
                </p>
              <% } else if (row.status==='Đã giao hàng' ) { %>
                <p style="color: rgb(9, 0, 128); font-weight: bold;">
                  <%= row.status %>
                </p>
                <% } else if (row.status==='Hủy đơn' || row.status==='Khách hủy đơn') { %>
                  <p style="color: red; font-weight: bold;">
                    <%= row.status %>
                  </p>
                  <% } %>
          </td>
          <td>
            <div class="d-flex">

              <% if (row.status==='Có đơn' || row.status==='Đang giao hàng' ) { %>
                <button type="button" class="btn btn-success" data-bs-toggle="modal"
                  data-bs-target="#exampleModal<%= row._id %>">
                  Xác nhận
                </button>

                <% } else if (row.status==='Đã giao hàng' ) { %>
                  <% } else if (row.status==='Hủy đơn' ) { %>
                    <% } %>

                      <div class="modal fade" id="exampleModal<%= row._id %>" tabindex="-1"
                        aria-labelledby="exampleModalLabel" aria-hidden="true"
                        data-bs-target="#exampleModal<%= row._id %>">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="exampleModalLabel">Xác nhận đơn</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"aria-label="Close"></button>
                            </div>
                            <% if (row.status==='Có đơn' ) { %>

                              <div class="modal-body">
                                Bạn có muốn xác nhận đơn hàng 
                              </div>

                              <div class="modal-footer">
                                    <a class="btn btn-danger" href="/oder/huyoders/<%= row._id%>">Hủy đơn</a>
                                    <a class="btn btn-success" href="/oder/duyetoders/<%= row._id%>">Xác nhận</a>
                              </div>

                              <% }else if(row.status==='Đang giao hàng' ) { %>
                                <div class="modal-body">
                                  Bạn có muốn xác nhận giao hàng thành công
                                </div>

                                <div class="modal-footer">
                                    <a class="btn btn-danger" href="/oder/huyoders/<%= row._id%>">Hủy đơn</a>
                                    <a class="btn btn-success" href="/oder/duyetoders/<%= row._id%>">Xác nhận</a>
                                </div>
                                <% } %>
                          </div>
                        </div>
                      </div>

            </div>
          </td>

        </tr>


      <% }) %>

        
    </table>
  </div> 


<script>
  document.addEventListener('DOMContentLoaded', function() {
    const categoryFilters = document.querySelectorAll('.category-filter');

    categoryFilters.forEach(function(filter) {
      filter.addEventListener('click', function(event) {
        event.preventDefault();

        const category = this.getAttribute('data-category');

        // Lặp qua từng dòng trong bảng và ẩn/cắt bớt dòng không khớp với danh mục được chọn
        const tableRows = document.querySelectorAll('#your-table-id tbody tr');
        tableRows.forEach(function(row) {
          const categoryCell = row.querySelector('td:nth-child(9)'); // Thay đổi chỉ mục (index) tùy thuộc vào vị trí của cột danh mục trong bảng

          if (categoryCell.innerText === category) {
            row.style.display = ''; // Hiển thị dòng nếu danh mục khớp
          } else {
            row.style.display = 'none'; // Ẩn dòng nếu danh mục không khớp
          }
        });
      });
    });
  });
</script>

<!-- thông báo về app -->
<script>
  if ('serviceWorker' in navigator && 'PushManager' in window) {
    navigator.serviceWorker.register('/service-worker.js')
      .then((registration) => {
        return registration.pushManager.getSubscription()
          .then(async (subscription) => {
            if (!subscription) {
              const response = await fetch('/api/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(subscription),
              });
              console.log('Đã đăng ký subscription:', response);
            }
          });
      })
      .catch((error) => {
        console.error('Lỗi khi đăng ký service worker:', error);
      });
  }

  function sendNotification(status) {
    fetch(`/api/send-notification?status=${status}`)
      .then((response) => {
        console.log('Đã gửi thông báo:', response);
      })
      .catch((error) => {
        console.error('Lỗi khi gửi thông báo:', error);
      });
  }
</script>


  <div style="margin-left: 850px; margin-top: 50px;">
    <nav aria-label="Page navigation example">
      <ul class="pagination">
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=1&limit=5">Previous</a></li>
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=1&limit=5">1</a></li>
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=2&limit=5">2</a></li>
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=3&limit=5">3</a></li>
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=4&limit=5">4</a></li>
        <li class="page-item"><a class="page-link" href="http://localhost:3000/oder?page=4&limit=5">Next</a></li>
      </ul>
    </nav>
  </div>


<%- include('../inc/footer.ejs') %>